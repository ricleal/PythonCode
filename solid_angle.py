#!/usr/bin/env python3

import numpy as np
import matplotlib.pyplot as plt

'''

'''


# Detector
# CG2: 192 tubes 256 pixels    
# xpixels="192" xstart="-0.52425" xstep="0.00550"
# ypixels="256" ystart="-0.54825" ystep="0.00430">
sdd = 4
detector_high = 0.54785
detector_width = 0.71141 # 0.53356 for 96 pixels
n_pixels_x = 128
n_pixels_y = 128

px = 5.5e-3
py = 4.3e-3

print("Pixel size = ({}, {})".format(px, py))

detector_intensity = np.ones(n_pixels_x)
detector_x = np.linspace(0, detector_width, num=n_pixels_x)
detector_y = np.linspace(0, detector_high, num=n_pixels_y)

#
two_theta = np.arctan2(np.sqrt(detector_x**2 + detector_y**2), sdd)
d_squared = sdd**2 + detector_x**2 + detector_y**2

solid_angle_cos3 = px * py * np.power(np.cos(two_theta), 3) / d_squared

alpha = np.arctan2(detector_x, sdd)
solid_angle_alpha_cos2 = px * py * np.cos(alpha) * \
    np.power(np.cos(two_theta), 2) / d_squared


x = np.sqrt(detector_x**2 + detector_y**2)

f, ax = plt.subplots()

ax.set_ylabel('Solid Angle')
ax.set_xlabel('2 theta')
ax.plot(two_theta, solid_angle_cos3, ".", label="SA cos3")
ax.plot(two_theta, solid_angle_alpha_cos2, ".", label="SA alpha cos2")

# # Code for mantid
# LoadEmptyInstrument(InstrumentName='cg2', OutputWorkspace='ws')
# MoveInstrumentComponent(Workspace="ws", ComponentName="detector1", RelativePosition=True, Z="4")
# SolidAngle(InputWorkspace="ws", OutputWorkspace="solid_angle")
# ws = mtd['solid_angle']
# i = ws.getInstrument()
# sample_pos = i.getSample().getPos()
# source_pos = i.getSource().getPos()
# beam = sample_pos - source_pos
# c = i.getComponentByName('detector1')
# x = []
# out = []
# for i in range (96):
#     p = c[95+i][127+i]
#     tt = p.getTwoTheta(sample_pos,beam)
#     x.append(tt)
#     out.append(ws.dataY(p.getID()-1)[0])

x = [0.0008726752622237657,
 0.0008726752622237657,
 0.002618020470020247,
 0.004363349727720333,
 0.006108652402601208,
 0.007853917862973087,
 0.00959913547844464,
 0.011344294620309416,
 0.013089384662101662,
 0.01483439497981544,
 0.016579314952417004,
 0.018324133962115834,
 0.02006884139481244,
 0.02181342664052237,
 0.023557879093708836,
 0.02530218815364285,
 0.027046343224881256,
 0.028790333717569956,
 0.030534149047853263,
 0.03227777863828761,
 0.03402121191818965,
 0.03576443832401907,
 0.03750744729977006,
 0.039250228297372035,
 0.04099277077704265,
 0.0427350642076799,
 0.044477098067235224,
 0.046218861843104184,
 0.04796034503249335,
 0.04970153714279854,
 0.05144242769198549,
 0.053183006208955795,
 0.05492326223394023,
 0.056663185318845,
 0.05840276502764282,
 0.060141990936731685,
 0.06188085263532521,
 0.06361933972579205,
 0.06535744182404243,
 0.06709514855989379,
 0.06883244957742603,
 0.07056933453534878,
 0.07230579310737432,
 0.07404181498256236,
 0.07577738986568694,
 0.07751250747760212,
 0.07924715755557603,
 0.0809813298536805,
 0.08271501414310496,
 0.0844482002125461,
 0.08618087786853186,
 0.08791303693578584,
 0.08964466725756161,
 0.09137575869600431,
 0.09310630113248275,
 0.09483628446793448,
 0.09656569862321333,
 0.09829453353941557,
 0.10002277917823073,
 0.10175042552226535,
 0.10347746257538483,
 0.10520388036304412,
 0.10692966893261388,
 0.10865481835370981,
 0.11037931871852047,
 0.11210316014212543,
 0.11382633276282783,
 0.11554882674246636,
 0.11727063226673433,
 0.11899173954549534,
 0.1207121388131033,
 0.12243182032870473,
 0.12415077437655231,
 0.12586899126631987,
 0.1275864613333926,
 0.1293031749391835,
 0.1310191224714242,
 0.1327342943444749,
 0.13444868099961124,
 0.13616227290531974,
 0.13787506055759322,
 0.13958703448021992,
 0.1412981852250681,
 0.14300850337236862,
 0.14471797953100696,
 0.1464266043387921,
 0.14813436846274322,
 0.14984126259935376,
 0.15154727747487898,
 0.15325240384559416,
 0.15495663249806588,
 0.1566599542494216,
 0.1583623599476064,
 0.16006384047164318,
 0.16176438673189616,
 0.16346398967032527]

out = [1.478122756025529e-06,
 1.478122756025529e-06,
 1.4781092553473535e-06,
 1.4780822472174185e-06,
 1.478041732869896e-06,
 1.477987714155977e-06,
 1.4779201935436899e-06,
 1.4778391741176136e-06,
 1.4777446595785506e-06,
 1.4776366542431607e-06,
 1.4775151630435242e-06,
 1.4773801915264385e-06,
 1.4772317458531285e-06,
 1.4770698327983307e-06,
 1.4768944597496997e-06,
 1.4767056347069444e-06,
 1.4765033662810708e-06,
 1.4762876636934756e-06,
 1.4760585367747235e-06,
 1.475815995963964e-06,
 1.4755600523072568e-06,
 1.4752907174567818e-06,
 1.4750080036696892e-06,
 1.4747119238064268e-06,
 1.4744024913296354e-06,
 1.4740797203025971e-06,
 1.4737436253880526e-06,
 1.4733942218461083e-06,
 1.4730315255330366e-06,
 1.4726555528994685e-06,
 1.472266320988549e-06,
 1.4718638474351362e-06,
 1.4714481504613244e-06,
 1.4710192488784002e-06,
 1.4705771620807272e-06,
 1.4701219100471643e-06,
 1.4696535133368969e-06,
 1.4691719930885342e-06,
 1.4686773710159045e-06,
 1.4681696694086322e-06,
 1.4676489111278446e-06,
 1.467115119603684e-06,
 1.4665683188342924e-06,
 1.4660085333815021e-06,
 1.4654357883704107e-06,
 1.464850109484411e-06,
 1.4642515229655504e-06,
 1.4636400556074522e-06,
 1.4630157347565638e-06,
 1.4623785883082522e-06,
 1.461728644701925e-06,
 1.4610659329215083e-06,
 1.4603904824885354e-06,
 1.4597023234639376e-06,
 1.4590014864392266e-06,
 1.4582880025379887e-06,
 1.4575619034110835e-06,
 1.4568232212333817e-06,
 1.456071988699925e-06,
 1.4553082390223303e-06,
 1.454532005929656e-06,
 1.4537433236570747e-06,
 1.4529422269492412e-06,
 1.4521287510548166e-06,
 1.451302931722302e-06,
 1.4504648051943539e-06,
 1.4496144082100271e-06,
 1.4487517779937093e-06,
 1.4478769522593248e-06,
 1.4469899691976801e-06,
 1.4460908674823137e-06,
 1.4451796862552866e-06,
 1.44425646513209e-06,
 1.4433212441961104e-06,
 1.4423740639887394e-06,
 1.441414965509203e-06,
 1.440443990216133e-06,
 1.439461180011635e-06,
 1.4384665772470294e-06,
 1.4374602247164416e-06,
 1.4364421656490927e-06,
 1.4354124437084115e-06,
 1.4343711029881645e-06,
 1.4333181880014762e-06,
 1.4322537436883331e-06,
 1.4311778154022967e-06,
 1.4300904489095367e-06,
 1.428991690382465e-06,
 1.427881586395836e-06,
 1.4267601839225975e-06,
 1.425627530329698e-06,
 1.4244836733792665e-06,
 1.423328661208343e-06,
 1.4221625423401074e-06,
 1.4209853656751297e-06,
 1.4197971804792308e-06]

ax.plot(x, out, ".", label="SA CG2 mantid cuboid")

out = [1.4788706628936096e-06,
 1.4788680967776565e-06,
 1.478852010651766e-06,
 1.4788224052512376e-06,
 1.4787792819292841e-06,
 1.478722642656908e-06,
 1.4786524900226661e-06,
 1.478568827232374e-06,
 1.478471658108923e-06,
 1.4783609870915415e-06,
 1.478236819235708e-06,
 1.4780991602123027e-06,
 1.4779480163072658e-06,
 1.477783394420597e-06,
 1.477605302065914e-06,
 1.4774137473698576e-06,
 1.477208739070308e-06,
 1.4769902865165232e-06,
 1.4767583996673952e-06,
 1.4765130890912232e-06,
 1.476254365963522e-06,
 1.4759822420666404e-06,
 1.4756967297878387e-06,
 1.4753978421191753e-06,
 1.475085592654598e-06,
 1.4747599955893758e-06,
 1.4744210657189545e-06,
 1.47406881843613e-06,
 1.4737032697305798e-06,
 1.4733244361873458e-06,
 1.47293233498295e-06,
 1.4725269838875745e-06,
 1.4721084012580924e-06,
 1.4716766060411508e-06,
 1.471231617766806e-06,
 1.4707734565495239e-06,
 1.4703021430867747e-06,
 1.4698176986506136e-06,
 1.469320145094073e-06,
 1.4688095048443735e-06,
 1.4682858008987406e-06,
 1.4677490568246872e-06,
 1.46719929676058e-06,
 1.4666365454055557e-06,
 1.4660608280215032e-06,
 1.4654721704333773e-06,
 1.464870599018399e-06,
 1.4642561407117853e-06,
 1.4636288229987416e-06,
 1.4629886739132109e-06,
 1.462335722034071e-06,
 1.4616699964840763e-06,
 1.4609915269258646e-06,
 1.4603003435571123e-06,
 1.459596477112274e-06,
 1.4588799588532346e-06,
 1.4581508205688182e-06,
 1.4574090945768205e-06,
 1.4566548137077981e-06,
 1.455888011318796e-06,
 1.4551087212739254e-06,
 1.4543169779484995e-06,
 1.4535128162294968e-06,
 1.452696271501551e-06,
 1.4518673796538723e-06,
 1.4510261770674706e-06,
 1.4501727006236705e-06,
 1.4493069876830928e-06,
 1.448429076101979e-06,
 1.4475390042038005e-06,
 1.446636810802281e-06,
 1.4457225351832936e-06,
 1.4447962170962416e-06,
 1.4438578967643255e-06,
 1.4429076148607497e-06,
 1.4419454125310474e-06,
 1.4409713313634272e-06,
 1.4399854134031607e-06,
 1.4389877011368277e-06,
 1.4379782374914847e-06,
 1.4369570658333122e-06,
 1.4359242299650473e-06,
 1.4348797741109485e-06,
 1.4338237429233081e-06,
 1.4327561814786749e-06,
 1.4316771352588875e-06,
 1.4305866501654236e-06,
 1.429484772507031e-06,
 1.4283715489872862e-06,
 1.4272470267215787e-06,
 1.4261112531977507e-06,
 1.4249642763151023e-06,
 1.4238061443432994e-06,
 1.4226369059330664e-06,
 1.4214566101196493e-06,
 1.420265306290505e-06]

ax.plot(x, out, ".", label="SA CG2 mantid cylinder")

ax.ticklabel_format(style='sci',scilimits=(-3,4),axis='both')
ax.legend()
plt.show()

